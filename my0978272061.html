<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MITA BETTING - ADMIN PANEL</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        html, body { max-width: 100%; overflow-x: hidden; margin: 0; padding: 0; background: #f4f4f4; font-family: 'Segoe UI', sans-serif; }
        .header { background: #ffcc00; padding: 15px; text-align: center; font-weight: 900; font-size: 18px; border-bottom: 3px solid #000; position: sticky; top: 0; z-index: 1000; }
        .section { background: white; margin: 10px; border: 2px solid #002d4b; border-radius: 8px; overflow: hidden; }
        .section-title { background: #002d4b; color: white; padding: 10px; font-size: 14px; font-weight: bold; text-transform: uppercase; }
        .card { padding: 12px; border-bottom: 1px solid #ddd; display: flex; flex-direction: column; gap: 5px; }
        .card:last-child { border-bottom: none; }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .phone-text { font-weight: 900; font-size: 18px; color: #000; letter-spacing: 1px; } /* ·àµ·àç·ä≠ ·âÅ·å•·à© ·åé·àç·â∑·àç */
        .pass-text { font-weight: 900; font-size: 16px; color: #d9534f; background: #ffeeee; padding: 2px 8px; border-radius: 4px; border: 1px solid #d9534f; }
        .user-name { color: #555; font-size: 14px; font-weight: bold; }
        .trans-no { background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-weight: bold; color: #333; font-size: 15px; margin: 5px 0; border: 1px solid #ccc; display: inline-block; }
        .btn-group { display: flex; gap: 5px; margin-top: 5px; }
        button { border: none; padding: 10px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        input[type="number"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 80px; }
        
        /* ·ã®·ãù·ãç·ãç·à≠ ·â≥·à™·ä≠ ·ä†·ã≤·àµ ·àµ·â≥·ã≠·àç */
        .history-item { border-bottom: 2px solid #eee; padding: 12px 10px; }
        .hist-time { color: #0056b3; font-weight: bold; font-size: 13px; display: block; margin-bottom: 4px; }
        .type-dep { color: green; font-weight: bold; font-size: 15px; }
        .type-with { color: red; font-weight: bold; font-size: 16px; text-transform: uppercase; }
        
        /* Withdrawal ·â≥·à™·ä≠ ·åé·àç·â∂ ·ä•·äï·ã≤·â≥·ã≠ */
        .history-item.withdraw-highlight {
            background: #fff0f0; 
            border-left: 6px solid #dc3545;
        }
    </style>
</head>
<body>

<div class="header">MITA BETTING - ADMIN PANEL</div>

<div class="section">
    <div class="section-title">·ã®·åà·äï·ãò·â• ·àõ·àµ·åà·â¢·ã´ ·å•·ã´·âÑ·ãé·âΩ (Deposits)</div>
    <div id="dep-list"></div>
</div>

<div class="section">
    <div class="section-title">·ã®·åà·äï·ãò·â• ·àõ·ãç·å´ ·å•·ã´·âÑ·ãé·âΩ (Withdrawals)</div>
    <div id="with-list"></div>
</div>

<div class="section">
    <div class="section-title">·â∞·å†·âÉ·àö·ãé·âΩ (User Management)</div>
    <div id="user-list"></div>
</div>

<div class="section">
    <div class="section-title">·ã®·àÇ·à≥·â• ·ãù·ãç·ãç·à≠ ·â≥·à™·ä≠ (Transaction History)</div>
    <div id="history-list" style="padding: 10px; max-height: 500px; overflow-y: auto; background: #fff;"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAApcQQ3XySdQ6YG4wnrTUPnm0wZB078QQ",
        authDomain: "bekas-fast-d2a3b.firebaseapp.com",
        databaseURL: "https://bekas-fast-d2a3b-default-rtdb.firebaseio.com",
        projectId: "bekas-fast-d2a3b",
        storageBucket: "bekas-fast-d2a3b.firebasestorage.app",
        messagingSenderId: "130702344830",
        appId: "1:130702344830:web:58577289ec2f3208a64e2f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 1. Load Deposits
    database.ref('deposit_requests').on('value', snap => {
        const cont = document.getElementById('dep-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card">
                <div class="row"><span class="phone-text">${r.phone}</span> <strong>${r.amount} ETB</strong></div>
                <div>Trans No: <span class="trans-no">${r.code || 'CODE NOT FOUND'}</span></div>
                <button class="btn-green" onclick="approveDep('${child.key}', '${r.phone}', ${r.amount})">APPROVE & ADD BALANCE</button>
            </div>`;
        });
    });

    // 2. Load Withdrawals
    database.ref('withdraw_requests').on('value', snap => {
        const cont = document.getElementById('with-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card">
                <div class="row"><span class="phone-text">${r.phone}</span> <strong>${r.amount} ETB</strong></div>
                <button class="btn-red" onclick="approveWithdraw('${child.key}', '${r.phone}', ${r.amount})">APPROVE (PAID)</button>
            </div>`;
        });
    });

    // 3. User Management
    database.ref('users').on('value', snap => {
        const cont = document.getElementById('user-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const u = child.val();
            const phone = child.key;
            cont.innerHTML += `<div class="card">
                <div class="row">
                    <div>
                        <span class="phone-text">${phone}</span> <br>
                        <span class="user-name">User: ${u.username || 'No Name'}</span>
                    </div>
                    <span class="pass-text">PW: ${u.password}</span>
                </div>
                <div class="row">
                    <span>Bal: <b>${(u.balance || 0).toFixed(2)}</b></span>
                    <div class="btn-group">
                        <input type="number" id="amt-${phone}" placeholder="Amt">
                        <button class="btn-green" onclick="adjustBal('${phone}', 'add')">+</button>
                        <button class="btn-red" onclick="adjustBal('${phone}', 'sub')">-</button>
                    </div>
                </div>
            </div>`;
        });
    });

    // 4. Load History - ·âÄ·äï·ç£ ·à∞·ãì·âµ ·ä•·äì ·àµ·àç·ä≠ ·åé·àç·â∂ ·ä•·äï·ã≤·â≥·ã≠ ·ã®·â∞·àµ·â∞·ä´·ä®·àà
    database.ref('transaction_history').limitToLast(30).on('value', snap => {
        const cont = document.getElementById('history-list'); cont.innerHTML = "";
        let items = [];
        snap.forEach(child => {
            const h = child.val();
            const isWithdraw = h.type === 'Withdraw';
            const typeClass = (h.type === 'Deposit' || h.type === 'Admin Add') ? 'type-dep' : 'type-with';
            
            items.unshift(`<div class="history-item ${isWithdraw ? 'withdraw-highlight' : ''}">
                <span class="hist-time">üìÖ ${h.time}</span>
                <span class="phone-text">üë§ ${h.phone}</span> <br>
                <span class="${typeClass}">${h.type}</span>: <b style="font-size: 18px;">${h.amount} ETB</b>
            </div>`);
        });
        cont.innerHTML = items.join("");
    });

    function logTransaction(phone, type, amount) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString() + " | " + now.toLocaleDateString();
        database.ref('transaction_history').push({
            phone: phone, type: type, amount: amount, time: timeStr
        });
    }

    function approveDep(reqId, phone, amt) {
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + amt)
        .then(() => {
            logTransaction(phone, 'Deposit', amt);
            database.ref('deposit_requests/' + reqId).remove();
        });
    }

    function approveWithdraw(reqId, phone, amt) {
        if(confirm(amt + " ETB ·àà·â∞·å†·âÉ·àö·ãç ·ä®·çç·àà·àÖ ·å®·à≠·à∞·àÉ·àç? (·åà·äï·ãò·â° ·âÄ·ãµ·àû ·â∞·âÄ·äï·à∑·àç)")) {
            logTransaction(phone, 'Withdraw', amt);
            database.ref('withdraw_requests/' + reqId).remove();
        }
    }

    function adjustBal(phone, type) {
        const el = document.getElementById('amt-' + phone);
        const v = parseFloat(el.value);
        if(!v) return;
        const change = (type === 'add') ? v : -v;
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + change)
        .then(() => {
            logTransaction(phone, type === 'add' ? 'Admin Add' : 'Admin Sub', v);
            el.value = "";
        });
    }
</script>
</body>
</html>
