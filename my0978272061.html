<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MITA BETTING - ADMIN PANEL</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        html, body { width: 100%; margin: 0; padding: 0; background: #f0f0f0; font-family: sans-serif; overflow-x: hidden; }
        .header { background: #ffcc00; padding: 10px; text-align: center; font-weight: 900; font-size: 18px; border-bottom: 2px solid #000; position: sticky; top: 0; z-index: 1000; }
        
        .section { background: white; margin-bottom: 5px; border-bottom: 2px solid #002d4b; width: 100%; }
        .section-title { background: #002d4b; color: white; padding: 8px; font-size: 14px; font-weight: 900; text-transform: uppercase; text-align: center; display: flex; justify-content: center; align-items: center; gap: 15px; }
        
        .card { padding: 10px 12px; border-bottom: 1px solid #ddd; width: 100%; box-sizing: border-box; position: relative; }
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .phone-text { font-weight: 900; font-size: 20px; color: #002d4b; }
        .user-name { color: #00b050; font-size: 20px; font-weight: 900; margin-left: 10px; text-transform: uppercase; }
        .pass-text { font-size: 20px; color: #ffffff; font-weight: 900; background: #dc3545; padding: 3px 10px; border-radius: 5px; border: 2px solid #000; display: inline-block; }
        
        .joined-date { font-size: 11px; color: #666; font-weight: bold; margin-top: 2px; display: block; }
        .del-user-btn { background: #000; color: #fff; border: 1px solid #fff; font-weight: 900; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-size: 14px; }

        .history-item { padding: 12px; border-bottom: 2px solid #ccc; background: #fff; border-left: 5px solid #002d4b; }
        .hist-date-row { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px dashed #ccc; padding-bottom: 3px; }
        .hist-date { font-size: 18px; font-weight: 900; color: #000; }
        .hist-time { font-size: 16px; font-weight: 900; color: #666; }

        .btn-clear { background: #ff4444; color: white; border: 2px solid #fff; padding: 5px 12px; font-size: 12px; cursor: pointer; font-weight: 900; border-radius: 4px; }
        button { border: 2px solid #000; padding: 8px; font-weight: 900; cursor: pointer; color: white; flex: 1; font-size: 14px; border-radius: 4px; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-blue { background: #002d4b; }
        input[type="number"] { padding: 8px; border: 2px solid #002d4b; width: 85px; font-weight: 900; font-size: 16px; border-radius: 4px; text-align: center; }
    </style>
</head>
<body>

<div class="header">MITA BETTING - ADMIN PANEL</div>

<div class="section">
    <div class="section-title">Password Recovery Requests</div>
    <div id="pw-req-list"></div>
</div>

<div class="section">
    <div class="section-title">Deposits</div>
    <div id="dep-list"></div>
</div>

<div class="section">
    <div class="section-title">Withdrawals</div>
    <div id="with-list"></div>
</div>

<div class="section">
    <div class="section-title">User Management</div>
    <div id="user-list"></div>
</div>

<div class="section">
    <div class="section-title">
        History 
        <button class="btn-clear" onclick="clearAllHistory()">CLEAR ALL</button>
    </div>
    <div id="history-list" style="max-height: 600px; overflow-y: auto;"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAApcQQ3XySdQ6YG4wnrTUPnm0wZB078QQ",
        authDomain: "bekas-fast-d2a3b.firebaseapp.com",
        databaseURL: "https://bekas-fast-d2a3b-default-rtdb.firebaseio.com",
        projectId: "bekas-fast-d2a3b",
        storageBucket: "bekas-fast-d2a3b.firebasestorage.app",
        messagingSenderId: "130702344830",
        appId: "1:130702344830:web:58577289ec2f3208a64e2f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // 1. Password Requests Loader (አዲስ የተጨመረ)
    database.ref('password_requests').on('value', snap => {
        const cont = document.getElementById('pw-req-list');
        cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `
                <div class="card">
                    <div class="row">
                        <span class="phone-text">${r.phone}</span>
                        <span style="font-size:12px; font-weight:900; color:#666;">${r.time}</span>
                    </div>
                    <div style="margin-top:8px; display:flex;">
                        <button class="btn-blue" onclick="clearPwReq('${child.key}')">DONE / DELETE</button>
                    </div>
                </div>`;
        });
    });

    function clearPwReq(reqId) {
        if(confirm("ጥያቄውን ከዝርዝር ማጥፋት ትፈልጋለህ?")) {
            database.ref('password_requests/' + reqId).remove();
        }
    }

    // 2. User Management Display
    database.ref('users').on('value', snap => {
        const cont = document.getElementById('user-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const u = child.val();
            const phone = child.key;
            const joined = u.createdAt || "ያልታወቀ ቀን";

            cont.innerHTML += `<div class="card">
                <div class="row">
                    <span>
                        <span class="phone-text">${phone}</span><span class="user-name">${u.username || ''}</span>
                        <span class="joined-date">Joined: ${joined}</span>
                    </span>
                    <span class="pass-text">${u.password}</span>
                </div>
                <div class="row" style="margin-top:10px;">
                    <span style="font-weight:900; font-size:17px;">BAL: ${(u.balance || 0).toFixed(1)}</span>
                    <div class="btn-group" style="display:flex; gap:5px; align-items:center;">
                        <input type="number" id="amt-${phone}" placeholder="Amt">
                        <button class="btn-green" style="max-width:40px;" onclick="adjustBal('${phone}', 'add')">+</button>
                        <button class="btn-red" style="max-width:40px;" onclick="adjustBal('${phone}', 'sub')">-</button>
                        <button class="del-user-btn" onclick="deleteUser('${phone}')">DEL</button>
                    </div>
                </div>
            </div>`;
        });
    });

    // 3. Deposits & Withdrawals
    database.ref('deposit_requests').on('value', snap => {
        const cont = document.getElementById('dep-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card"><div class="row"><span class="phone-text">${r.phone}</span><span style="color:#28a745; font-weight:900;">${r.amount}</span></div><button class="btn-green" onclick="approveDep('${child.key}', '${r.phone}', ${r.amount})">APPROVE</button></div>`;
        });
    });

    database.ref('withdraw_requests').on('value', snap => {
        const cont = document.getElementById('with-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card"><div class="row"><span class="phone-text">${r.phone}</span><span style="color:#dc3545; font-weight:900;">${r.amount}</span></div><button class="btn-red" onclick="approveWithdraw('${child.key}', '${r.phone}', ${r.amount})">PAID</button></div>`;
        });
    });

    // 4. History Display
    database.ref('transaction_history').limitToLast(50).on('value', snap => {
        const cont = document.getElementById('history-list'); cont.innerHTML = "";
        let items = [];
        snap.forEach(child => {
            const h = child.val();
            const isPos = (h.type.includes('Deposit') || h.type.includes('Add') || h.type.includes('Win'));
            let timeVal = h.time || "";
            let timePart = timeVal.includes('|') ? timeVal.split('|')[0].trim() : timeVal.split(' ')[0];
            let datePart = timeVal.includes('|') ? timeVal.split('|')[1].trim() : (timeVal.split(' ')[1] || "");

            items.unshift(`
                <div class="history-item">
                    <div class="hist-date-row">
                        <span class="hist-date">${datePart}</span>
                        <span class="hist-time">${timePart}</span>
                    </div>
                    <div class="row">
                        <span class="phone-text">${h.phone}</span>
                        <span style="color:${isPos?'#28a745':'#dc3545'}; font-size:22px; font-weight:900;">${h.amount}</span>
                    </div>
                    <div style="font-size:12px; font-weight:900; color:#444;">TYPE: ${h.type.toUpperCase()}</div>
                </div>
            `);
        });
        cont.innerHTML = items.join("");
    });

    // --- Helper Functions ---
    function deleteUser(phone) {
        if(confirm("ተጠቃሚውን (" + phone + ") ማጥፋት ትፈልጋለህ?")) {
            database.ref('users/' + phone).remove();
        }
    }

    function clearAllHistory() {
        if(confirm("ታሪክ ማጥፋት ትፈልጋለህ?")) {
            database.ref('transaction_history').remove();
        }
    }

    function logTransaction(phone, type, amount) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + " | " + now.toLocaleDateString();
        database.ref('transaction_history').push({ phone, type, amount, time: timeStr });
    }

    function adjustBal(phone, type) {
        const el = document.getElementById('amt-' + phone);
        const v = parseFloat(el.value);
        if(!v || v % 10 !== 0) { alert("የ10 ብዜት ቁጥር ብቻ!"); return; }
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + ((type === 'add') ? v : -v)).then(() => {
            logTransaction(phone, type === 'add' ? 'Admin Add' : 'Admin Sub', v);
            el.value = "";
        });
    }

    function approveDep(reqId, phone, amt) {
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + amt).then(() => {
            logTransaction(phone, 'Deposit', amt);
            database.ref('deposit_requests/' + reqId).remove();
        });
    }

    function approveWithdraw(reqId, phone, amt) {
        database.ref('users/' + phone + '/balance').transaction(c => (c >= amt ? c - amt : c)).then(() => {
            logTransaction(phone, 'Withdraw', amt);
            database.ref('withdraw_requests/' + reqId).remove();
        });
    }
</script>
</body>
</html>