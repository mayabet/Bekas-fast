<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MITA BETTING - ADMIN PANEL</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        html, body { width: 100%; margin: 0; padding: 0; background: #f0f0f0; font-family: sans-serif; overflow-x: hidden; }
        .header { background: #ffcc00; padding: 10px; text-align: center; font-weight: 900; font-size: 18px; border-bottom: 2px solid #000; position: sticky; top: 0; z-index: 1000; }
        .section { background: white; margin-bottom: 10px; border-bottom: 2px solid #002d4b; width: 100%; }
        .section-title { background: #002d4b; color: white; padding: 8px; font-size: 13px; font-weight: 900; text-transform: uppercase; text-align: center; }
        .card { padding: 8px 12px; border-bottom: 1px solid #ddd; width: 100%; box-sizing: border-box; }
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .phone-text { font-weight: 900; font-size: 17px; color: #002d4b; }
        .user-name { color: #666; font-size: 14px; font-weight: 700; margin-left: 5px; }
        .amt-bold { color: #28a745; font-weight: 900; font-size: 18px; background: #e8f5e9; padding: 2px 8px; border-radius: 4px; border: 1px solid #28a745; }
        .trans-no-box { font-size: 13px; color: #333; background: #f1f1f1; font-weight: 700; padding: 3px 6px; border-radius: 4px; border: 1px solid #ccc; font-family: monospace; }
        .btn-green { background: #28a745; color: white; border: 1px solid #000; padding: 6px 12px; font-weight: 900; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .btn-red { background: #dc3545; color: white; border: 1px solid #000; padding: 6px 12px; font-weight: 900; font-size: 12px; border-radius: 4px; cursor: pointer; }
        .pass-text { font-size: 14px; color: #ffffff; font-weight: 900; background: #dc3545; padding: 2px 6px; border-radius: 4px; }
        input[type="number"] { padding: 5px; border: 2px solid #002d4b; width: 85px; font-weight: 900; font-size: 14px; border-radius: 4px; text-align: center; }
        .history-item { padding: 8px 12px; border-bottom: 2px solid #ccc; background: #fff; border-left: 4px solid #002d4b; margin-bottom: 2px; font-size: 13px; }
        .stat-table { width: 100%; border-collapse: collapse; text-align: center; font-weight: 900; margin-top: 5px; }
        .stat-table td, .stat-table th { border: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>

<div class="header">MITA BETTING - ADMIN PANEL</div>

<div class="section">
    <div class="section-title" style="background: #d00000; display: flex; justify-content: space-between; padding: 8px 15px;">
        <span>Lost Password Requests</span>
        <button onclick="if(confirm('ሁሉንም ጥያቄዎች ላጥፋ?')) database.ref('password_requests').remove();" style="font-size:10px; cursor:pointer;">CLEAR ALL</button>
    </div>
    <div id="lost-pw-list"></div>
</div>

<div class="section">
    <div class="section-title">Deposit Requests (ማስገቢያ)</div>
    <div id="dep-list"></div>
</div>

<div class="section">
    <div class="section-title">Withdrawal Requests (ማውጫ)</div>
    <div id="with-list"></div>
</div>

<div class="section">
    <div class="section-title">User Management</div>
    <div id="user-list"></div>
</div>

<div class="section">
    <div class="section-title">24H Game Stats (የተደረጉ ጨዋታዎች)</div>
    <table class="stat-table">
        <tr style="background: #eee; font-size: 12px;">
            <th>Play 1 (10)</th>
            <th>Play 2 (10)</th>
            <th>Play 3 (20)</th>
            <th>Play 4 (20)</th>
        </tr>
        <tr>
            <td id="stat-play1">0</td>
            <td id="stat-play2">0</td>
            <td id="stat-play3">0</td>
            <td id="stat-play4">0</td>
        </tr>
    </table>
</div>

<div class="section">
    <div class="section-title" style="display:flex; justify-content: space-around; align-items: center;">
        Transaction History 
        <button onclick="if(confirm('ታሪኩ ይጥፋ?')) database.ref('transaction_history').remove();" style="font-size:10px;">CLEAR</button>
    </div>
    <div id="history-list" style="max-height: 400px; overflow-y: auto;"></div>
</div>

<div class="section" style="text-align: center; padding: 15px; background: #fff0f0;">
    <button onclick="clearAllDataExceptUsers()" style="background: #000; color: #fff; padding: 12px 20px; font-weight: 900; border-radius: 5px; cursor: pointer; border: 2px solid red; width: 95%;">
        DELETE ALL DATA (STATS & HISTORY)
    </button>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAApcQQ3XySdQ6YG4wnrTUPnm0wZB078QQ",
        authDomain: "bekas-fast-d2a3b.firebaseapp.com",
        databaseURL: "https://bekas-fast-d2a3b-default-rtdb.firebaseio.com",
        projectId: "bekas-fast-d2a3b",
        storageBucket: "bekas-fast-d2a3b.firebasestorage.app",
        messagingSenderId: "130702344830",
        appId: "1:130702344830:web:58577289ec2f3208a64e2f"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- 1. User Management ---
    database.ref('users').on('value', snap => {
        const cont = document.getElementById('user-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const u = child.val(); const phone = child.key;
            cont.innerHTML += `<div class="card">
                <div class="row"><span><span class="phone-text">${phone}</span><span class="user-name">${u.username || ''}</span></span><span class="pass-text">${u.password}</span></div>
                <div class="row" style="margin-top:8px;">
                    <span style="font-weight:900; font-size:14px;">BAL: ${(u.balance || 0).toFixed(2)} ETB</span>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="amt-${phone}" placeholder="Amount" oninput="if(this.value.length > 5) this.value = this.value.slice(0,5);">
                        <button class="btn-green" onclick="adjustBal('${phone}', 'add')">+</button>
                        <button class="btn-red" onclick="adjustBal('${phone}', 'sub')">-</button>
                        <button class="btn-red" style="background:#000; margin-left:10px;" onclick="deleteAccount('${phone}')">DEL</button>
                    </div>
                </div>
            </div>`;
        });
    });

    function adjustBal(phone, type) {
        const el = document.getElementById('amt-' + phone);
        const valStr = el.value;
        const v = parseInt(valStr);
        if (!v || v < 10 || v % 10 !== 0 || valStr.length > 5) {
            alert("ስህተት፡ እስከ 5 ዲጂት እና የ10 ብዜት የሆነ ቁጥር ብቻ ያስገቡ!");
            el.value = "";
            return;
        }
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + (type === 'add' ? v : -v)).then(() => {
            logTransaction(phone, type === 'add' ? 'Admin Add' : 'Admin Sub', v);
            el.value = "";
            alert("ተሳክቷል!");
        });
    }

    // --- 2. Deposit Approval ---
    database.ref('deposit_requests').on('value', snap => {
        const cont = document.getElementById('dep-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card">
                <div class="row"><span class="phone-text">${r.phone}</span><span class="amt-bold">${r.amount} ETB</span></div>
                <div class="row" style="margin-top:5px;"><span class="trans-no-box">ID: ${r.transactionCode}</span>
                <button class="btn-green" onclick="approveDep('${child.key}', '${r.phone}', ${r.amount})">APPROVE</button></div>
            </div>`;
        });
    });

    function approveDep(key, phone, amt) {
        database.ref('users/' + phone + '/balance').transaction(c => (c || 0) + amt).then(() => {
            database.ref('deposit_requests/' + key).remove();
            logTransaction(phone, 'Deposit Approved', amt);
            alert("Approved!");
        });
    }

    // --- 3. Withdrawal Handling ---
    database.ref('withdraw_requests').on('value', snap => {
        const cont = document.getElementById('with-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card" style="border-left: 5px solid #ffcc00;">
                <div class="row"><span class="phone-text">${r.phone}</span><span class="amt-bold" style="color:red; background:#fff0f0; border-color:red;">${r.amount} ETB</span></div>
                <div class="row" style="margin-top:5px;"><span>Bank: ${r.bankName || 'CBE'}</span>
                <button class="btn-red" onclick="database.ref('withdraw_requests/${child.key}').remove(); alert('Done!');">DONE</button></div>
            </div>`;
        });
    });

    // --- 4. Password Requests ---
    database.ref('password_requests').on('value', snap => {
        const cont = document.getElementById('lost-pw-list'); cont.innerHTML = "";
        snap.forEach(child => {
            const r = child.val();
            cont.innerHTML += `<div class="card" style="border-left: 5px solid #d00000;">
                <div class="row"><span class="phone-text">${r.phone}</span><span>${r.time}</span></div>
                <div class="row" style="margin-top:5px;"><span>User: ${r.username}</span>
                <button class="btn-red" onclick="database.ref('password_requests/${child.key}').remove()">DONE</button></div>
            </div>`;
        });
    });

    // --- 5. Transaction History ---
    database.ref('transaction_history').limitToLast(50).on('value', snap => {
        const cont = document.getElementById('history-list'); cont.innerHTML = "";
        let items = [];
        snap.forEach(child => { items.unshift(child.val()); });
        items.forEach(h => {
            cont.innerHTML += `<div class="history-item">
                <div class="row"><b>${h.phone}</b> <span>${h.amount} ETB</span></div>
                <div class="row" style="color:#666; font-size:11px;"><span>${h.type}</span> <span>${h.time}</span></div>
            </div>`;
        });
    });

    function logTransaction(phone, type, amount) {
        const now = new Date(); const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) + " | " + now.toLocaleDateString();
        database.ref('transaction_history').push({ phone, type, amount, time: timeStr });
    }

    // --- 6. Game Stats (Last 24H) ---
    function updateGameStats() {
        const oneDayAgo = Date.now() - (24 * 60 * 60 * 1000);
        ['play1', 'play2', 'play3', 'play4'].forEach(game => {
            database.ref('games/' + game).orderByChild('timestamp').startAt(oneDayAgo).on('value', snap => {
                document.getElementById('stat-' + game).innerText = snap.numChildren();
            });
        });
    }
    updateGameStats();

    function deleteAccount(phone) {
        if(confirm("መለያውን ለመሰረዝ እርግጠኛ ነዎት?")) database.ref('users/' + phone).remove();
    }

    // --- 7. Clear All Logic (Including Stats) ---
    function clearAllDataExceptUsers() {
        if(confirm("ተጠንቀቅ! ሁሉንም ታሪክ እና የጨዋታ ስታቲስቲክስ ያጠፋል። እርግጠኛ ነህ?")) {
            database.ref('deposit_requests').remove();
            database.ref('withdraw_requests').remove();
            database.ref('transaction_history').remove();
            database.ref('password_requests').remove();
            database.ref('used_transactions').remove();
            
            // የጨዋታውን ስታቲስቲክስ 0 ለማድረግ ዳታውን ማጥፋት
            database.ref('games').remove(); 
            
            alert("ሁሉም መረጃዎች ተሰርዘዋል! ስታቲስቲክስ ከ 0 ይጀምራል።");
        }
    }
</script>
</body>
</html>
